#!/bin/bash
# TrenchBroom MCP Wrapper Script
# Simple wrapper for HTTP API calls to the TrenchBroom MCP server
# Usage: ./tb-mcp <command> [arguments]

set -e

MCP_SERVER="http://localhost:9875"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper function to make API calls
call_tool() {
    local tool=$1
    local params=$2
    
    response=$(curl -s -X POST "$MCP_SERVER/invoke" \
        -H "Content-Type: application/json" \
        -d "{\"tool\": \"$tool\", \"parameters\": $params}" 2>/dev/null)
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}✗ Error: Failed to connect to TrenchBroom MCP server${NC}"
        echo "Make sure the server is running:"
        echo "  launchctl load ~/Library/LaunchAgents/com.q1k3.trenchbroom-mcp.plist"
        exit 1
    fi
    
    echo "$response"
}

# Helper to parse JSON response using Python
json_extract() {
    local json="$1"
    local key="$2"
    python3 -c "import json,sys; data=json.load(sys.stdin); print(json.dumps(data.get('result',{}).get('$key','')))" <<< "$json" | tr -d '"'
}

json_success() {
    local json="$1"
    python3 -c "import json,sys; data=json.load(sys.stdin); print('true' if data.get('result',{}).get('success') else 'false')" <<< "$json"
}

# Helper to check if server is running
check_server() {
    # Try to connect to invoke endpoint which responds immediately
    if ! curl -s --max-time 2 -X POST "$MCP_SERVER/invoke" \
        -H "Content-Type: application/json" \
        -d '{"tool": "get_map_info"}' > /dev/null 2>&1; then
        echo -e "${RED}✗ TrenchBroom MCP server is not running${NC}"
        echo "Start it with:"
        echo "  launchctl load ~/Library/LaunchAgents/com.q1k3.trenchbroom-mcp.plist"
        exit 1
    fi
}
show_help() {
    cat << EOF
TrenchBroom MCP Wrapper - HTTP API Client

Usage: tb-mcp <command> [arguments]

Commands:
  launch [map_file]     Launch TrenchBroom (optionally with map file)
  load <map_file>       Load a .map file (e.g., 'm1.map')
  info                  Get info about currently loaded map
  save [map_file]       Save the current map
  compile               Compile map to .plb binary
  add <classname> <x> <y> <z> [properties]
                        Add entity at position (e.g., 'pickup_health 100 200 300')
  move <entity_id> <x> <y> <z>
                        Move entity to new position
  move-brush <entity_id> <brush_index> <dx> <dy> <dz>
                        Move brush by offset
  find-at <x> <y> <z> [radius]
                        Find entities/brushes near point
  status                Check if server is running
  help                  Show this help message

Examples:
  tb-mcp launch                    # Launch TrenchBroom
  tb-mcp launch m1.map             # Launch with m1.map
  tb-mcp load m1.map               # Load m1.map
  tb-mcp add enemy_grunt 100 200 64  # Add enemy at position
  tb-mcp move 5 150 250 80         # Move entity #5
  tb-mcp compile                   # Compile current map

EOF
}

# Main command handler
case "${1:-help}" in
    launch|start)
        check_server
        map_file="${2:-}"
        if [ -n "$map_file" ]; then
            echo -e "${YELLOW}Launching TrenchBroom with $map_file...${NC}"
            result=$(call_tool "launch_trenchbroom" "{\"map_file\": \"$map_file\"}")
        else
            echo -e "${YELLOW}Launching TrenchBroom...${NC}"
            result=$(call_tool "launch_trenchbroom" "{}")
        fi
        
        if [ "$(json_success "$result")" = "true" ]; then
            message=$(json_extract "$result" "message")
            echo -e "${GREEN}✓ $message${NC}"


        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    load)
        if [ -z "${2:-}" ]; then
            echo -e "${RED}✗ Error: Map file required${NC}"
            echo "Usage: tb-mcp load <map_file>"
            exit 1
        fi
        check_server
        echo -e "${YELLOW}Loading map: $2${NC}"
        result=$(call_tool "load_map" "{\"map_file\": \"$2\"}")
        
        if [ "$(json_success "$result")" = "true" ]; then
            entity_count=$(json_extract "$result" "entity_count")
            brush_count=$(json_extract "$result" "brush_count")
            echo -e "${GREEN}✓ Map loaded: $entity_count entities, $brush_count brushes${NC}"



        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    info|status-map)
        check_server
        result=$(call_tool "get_map_info" "{}")
        
        if [ "$(json_success "$result")" = "true" ]; then
            echo "$result" | python3 -m json.tool 2>/dev/null || echo "$result"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ $error${NC}"
            exit 1
        fi
        ;;
        
    save)
        check_server
        map_file="${2:-}"
        if [ -n "$map_file" ]; then
            echo -e "${YELLOW}Saving map as $map_file...${NC}"
            result=$(call_tool "save_map" "{\"map_file\": \"$map_file\"}")
        else
            echo -e "${YELLOW}Saving map...${NC}"
            result=$(call_tool "save_map" "{}")
        fi
        
        if echo "$result" | grep -q '"success": true'; then
            echo -e "${GREEN}✓ Map saved${NC}"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    compile|build)
        check_server
        echo -e "${YELLOW}Compiling map...${NC}"
        result=$(call_tool "compile_map" "{}")
        
        if echo "$result" | grep -q '"success": true'; then
            echo -e "${GREEN}✓ Map compiled successfully${NC}"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    add)
        if [ -z "${4:-}" ]; then
            echo -e "${RED}✗ Error: classname and position required${NC}"
            echo "Usage: tb-mcp add <classname> <x> <y> <z> [properties]"
            echo "Example: tb-mcp add pickup_health 100 200 64"
            exit 1
        fi
        check_server
        classname="$2"
        x="$3"
        y="$4"
        z="$5"
        properties="${6:-{}}"
        
        echo -e "${YELLOW}Adding $classname at ($x, $y, $z)...${NC}"
        result=$(call_tool "add_entity" "{\"classname\": \"$classname\", \"origin\": [$x, $y, $z], \"properties\": $properties}")
        
        if echo "$result" | grep -q '"success": true'; then
            entity_id=$(echo "$result" | grep -o '"entity_id": [0-9]*' | cut -d' ' -f2)
            echo -e "${GREEN}✓ Entity added with ID: $entity_id${NC}"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    move)
        if [ -z "${5:-}" ]; then
            echo -e "${RED}✗ Error: entity_id and position required${NC}"
            echo "Usage: tb-mcp move <entity_id> <x> <y> <z>"
            exit 1
        fi
        check_server
        entity_id="$2"
        x="$3"
        y="$4"
        z="$5"
        
        echo -e "${YELLOW}Moving entity $entity_id to ($x, $y, $z)...${NC}"
        result=$(call_tool "move_entity" "{\"entity_id\": $entity_id, \"origin\": [$x, $y, $z]}")
        
        if echo "$result" | grep -q '"success": true'; then
            echo -e "${GREEN}✓ Entity moved${NC}"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    move-brush|move_brush)
        if [ -z "${6:-}" ]; then
            echo -e "${RED}✗ Error: entity_id, brush_index and offset required${NC}"
            echo "Usage: tb-mcp move-brush <entity_id> <brush_index> <dx> <dy> <dz>"
            exit 1
        fi
        check_server
        entity_id="$2"
        brush_index="$3"
        dx="$4"
        dy="$5"
        dz="$6"
        
        echo -e "${YELLOW}Moving brush $brush_index in entity $entity_id by ($dx, $dy, $dz)...${NC}"
        result=$(call_tool "move_brush" "{\"entity_id\": $entity_id, \"brush_index\": $brush_index, \"offset\": [$dx, $dy, $dz]}")
        
        if echo "$result" | grep -q '"success": true'; then
            echo -e "${GREEN}✓ Brush moved${NC}"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    find-at|find_at|find)
        if [ -z "${4:-}" ]; then
            echo -e "${RED}✗ Error: position required${NC}"
            echo "Usage: tb-mcp find-at <x> <y> <z> [radius]"
            exit 1
        fi
        check_server
        x="$2"
        y="$3"
        z="$4"
        radius="${5:-32}"
        
        echo -e "${YELLOW}Searching for geometry at ($x, $y, $z) with radius $radius...${NC}"
        result=$(call_tool "get_geometry_at_point" "{\"position\": [$x, $y, $z], \"radius\": $radius}")
        
        if echo "$result" | grep -q '"success": true'; then
            echo "$result" | python3 -m json.tool 2>/dev/null || echo "$result"
        else
            error=$(echo "$result" | grep -o '"error": "[^"]*"' | cut -d'"' -f4)
            echo -e "${RED}✗ Failed: $error${NC}"
            exit 1
        fi
        ;;
        
    status|check)
        if curl -s --max-time 2 -X POST "$MCP_SERVER/invoke" \
            -H "Content-Type: application/json" \
            -d '{"tool": "get_map_info"}' > /dev/null 2>&1; then
            echo -e "${GREEN}✓ TrenchBroom MCP server is running on port 9875${NC}"


        else
            echo -e "${RED}✗ TrenchBroom MCP server is not running${NC}"
            echo "Start it with:"
            echo "  launchctl load ~/Library/LaunchAgents/com.q1k3.trenchbroom-mcp.plist"
            exit 1
        fi
        ;;
        
    help|-h|--help)
        show_help
        ;;
        
    *)
        echo -e "${RED}✗ Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
